name: GitOps Lint

on:
  pull_request:
    branches: [main]
    paths:
      - 'gitops/**'
      - '.github/workflows/gitops-lint.yml'
  push:
    branches: [main]
    paths:
      - 'gitops/**'
      - '.github/workflows/gitops-lint.yml'

permissions:
  contents: read

jobs:
  validate-manifests:
    name: Validate Kustomize & YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.7.1'

      - name: Validate ArgoCD app-of-apps
        run: kustomize build gitops/argocd/

      - name: Validate YAML syntax
        run: |
          find gitops/ -name '*.yaml' -o -name '*.yml' | while read f; do
            echo "Checking $f"
            python3 -c "import yaml; yaml.safe_load(open('$f'))" || exit 1
          done

      - name: Validate Kubeflow kustomization
        run: kustomize build gitops/apps/kubeflow/
